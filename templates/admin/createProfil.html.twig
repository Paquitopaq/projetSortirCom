{% extends 'base.html.twig' %}

{% block title %}Modifier mon profil{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/edit-profil.css') }}">
{% endblock %}

{% block body %}
    <div class="profile-wrapper">
        <div class="profile-card">
            <div class="profile-left">
                <div class="photo-section">
                    <div class="photo-preview">
                        {% if participant.photoProfil %}
                            <img id="preview-image" src="{{ asset(app.user.getAvatarPath()) }}" alt="Photo de profil">
                        {% else %}
                            <img id="preview-image" src="{{ asset('assets/avatars/cchat.png') }}" alt="Photo de profil">
                        {% endif %}
                    </div>
                    <label for="profil_photoProfil" class="upload-btn">
                        <i class="fa-solid fa-camera"></i> Changer la photo
                    </label>

                    <!-- ðŸ”¹ Bouton pour ouvrir le modal -->
                    <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#avatarModal">
                        Choisir une photo proposÃ©e
                    </button>
                </div>
            </div>

            <div class="profile-right">
                <h2>CrÃ©er un profil utilisateur</h2>

                {% for message in app.flashes('success') %}
                    <div class="alert alert-success text-center">{{ message }}</div>
                {% endfor %}

                {{ form_start(form, {'attr': {'class': 'profile-form'}, 'method': 'POST', 'enctype': 'multipart/form-data'}) }}
                <!-- ðŸ”¹ Champ cachÃ© pour stocker le choix de lâ€™avatar -->
                <input type="hidden" name="selected_avatar" id="selected_avatar">

                <div style="display: none">
                    {{ form_widget(form.photoProfil, {'attr': {'id': 'profil_photoProfil', 'accept': 'image/*'}}) }}
                </div>

                <div class="fields-grid">
                    <div class="field">
                        {{ form_label(form.pseudo, 'Pseudo') }}
                        {{ form_widget(form.pseudo) }}
                    </div>
                    <div class="field">
                        {{ form_label(form.nom, 'Nom') }}
                        {{ form_widget(form.nom) }}
                    </div>
                    <div class="field">
                        {{ form_label(form.prenom, 'PrÃ©nom') }}
                        {{ form_widget(form.prenom) }}
                    </div>
                    <div class="field">
                        {{ form_label(form.telephone, 'TÃ©lÃ©phone') }}
                        {{ form_widget(form.telephone) }}
                    </div>
                    <div class="field">
                        {{ form_label(form.email, 'Email') }}
                        {{ form_widget(form.email) }}
                    </div>
                    <div class="field">
                        {{ form_label(form.plainPassword, 'Password') }}
                        {{ form_widget(form.plainPassword) }}
                    </div>
                </div>

                <div class="submit-wrapper">
                    {{ form_widget(form.submit) }}
                </div>

                {{ form_end(form) }}

                <!-- ðŸ”¹ Modal avec les avatars -->
                <div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="avatarModalLabel">Choisir un avatar</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div class="d-flex flex-wrap justify-content-center">
                                    {% for avatar in avatars %}
                                        <img src="{{ asset('assets/avatars/' ~ avatar) }}"
                                             alt="Avatar"
                                             class="m-2 border rounded avatar-choice"
                                             style="width:80px; height:80px; cursor:pointer;">
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% include 'partials/_footer.html.twig' %}

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('profil_photoProfil');
            const preview = document.getElementById('preview-image');
            const hiddenAvatar = document.getElementById('selected_avatar');

            if (input) {
                input.addEventListener('change', e => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = ev => {
                            preview.src = ev.target.result;
                            hiddenAvatar.value = ''; // ðŸ”¹ On rÃ©initialise lâ€™avatar choisi
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
    </script>

    <script>
        document.querySelectorAll('.avatar-choice').forEach(img => {
            img.addEventListener('click', e => {
                document.getElementById('selected_avatar').value = e.target.getAttribute('src').split('/').pop();

                // ðŸ”¹ Mettre Ã  jour l'image de prÃ©visualisation
                document.getElementById('preview-image').src = e.target.src;

                // ðŸ”¹ Fermer le modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('avatarModal'));
                modal.hide();
            });
        });
    </script>
{% endblock %}
